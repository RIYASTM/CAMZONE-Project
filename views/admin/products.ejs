<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products | CAMZONE</title>
    <link rel="stylesheet" href="/stylesheet/partials/admins/sidebar.css">
    <link rel="stylesheet" href="/stylesheet/partials/admins/header.css">
    <link rel="stylesheet" href="/stylesheet/admin/products.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css">
</head>
<body>
    <div class="container">
        <!-- Include Sidebar -->
        <%- include('../partials/admins/sidebar') %>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Include Header -->
            <%- include('../partials/admins/header') %>
            
            <!-- Products Top Bar -->
            <div class="products-top-bar">
                <div class="top-left">
                    <span>All Products |</span>
                    <select class="sort-by">
                        <option value="default">Sort by</option>
                        <option value="name">Name</option>
                        <option value="price">Price</option>
                        <option value="stock">Stock</option>
                    </select>
                </div>
                <div class="top-center" style="position: relative; display: inline-block;">
                    <input type="text" class="search-bar" id="search" placeholder="Search" value="<%= search %>">
                    <% if(search){ %>
                        <button class="clear" id="clear-button"><i class="bi bi-x fs-1"></i></button>
                    <% } %>
                </div>
                <div class="top-right">
                    <button class="stock-manage">Stock Manage</button>
                    <select class="filter">
                        <option value="all">Filter</option>
                        <option value="listed">Listed</option>
                        <option value="unlisted">Unlisted</option>
                    </select>
                    <button class="add-product" id="addProductButton">Add New Product</button>
                </div>
            </div>
            
            <!-- Products Table -->
            <div class="products-table">
                <table>
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Name</th>
                            <th>Brand</th>
                            <th>Category</th>
                            <th>Created At</th>
                            <th>Price</th>
                            <th>Sell Price</th>
                            <th>Stock</th>
                            <th>Offer</th>
                            <th>Listed</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% products.forEach(product => { %>
                            <tr>
                                <td>
                                    <% if (product.productImage && product.productImage.length > 0) { %>
                                        <img src="<%= product.productImage[0] %>" alt="<%= product.productName %>" style="width: 100px; height: 100px; object-fit: fill;">
                                    <% } else { %>
                                        <span>No Image</span>
                                    <% } %>
                                </td>
                                <td><%= product.productName %></td>
                                <td><%= product.brand.brandName %></td>
                                <td><%= product.category.name %></td>
                                <td><%= new Date(product.createdAt).toLocaleDateString() %></td>
                                <td><%= '₹ ' + product.regularPrice %></td>
                                <td><%= '₹ ' + product.salePrice%></td>
                                <td><%= product.quantity + ' Pcs' %></td>
                                <td><%= product.productOffer ? product.productOffer + ' %' : '-' %></td>
                                <td><%= product.isBlocked ? 'Blocked' : 'Active' %></td>
                                <td>
                                    <a href="#" class="action-icon editProductButton" 
                                       data-id="<%= product._id %>" 
                                       data-name="<%= product.productName %>" 
                                       data-description="<%= product.description %>" 
                                       data-brand="<%= product.brand._id %>" 
                                       data-category="<%= product.category._id %>" 
                                       data-regularprice="<%= product.regularPrice %>" 
                                       data-saleprice="<%= product.salePrice %>" 
                                       data-productoffer="<%= product.productOffer %>" 
                                       data-stock="<%= product.quantity %>" 
                                       data-listed="<%= product.isBlocked %>" 
                                       data-images="<%= JSON.stringify(product.productImage) %>"
                                       data-page="<%= currentPages %>"><i class="fas fa-edit"></i></a>

                                    <a href="#" class="action-icon deleteProduct" 
                                        data-id="<%= product._id %>" 
                                        data-name="<%= product.productName %>"
                                        data-page="<%= currentPages %>"><i class="fas fa-trash"></i></a>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <%- include('../partials/admins/pagination', { currentPages, totalPages }) %>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal product-modal" id="addProductModal">
        <div class="modal-content">
            <button type="button" class="close-btn" id="cancelAddProductButton">×</button>
            <div class="modal-header">
                <h2>Add New Product</h2>
            </div>
            <form action="/admin/addProduct" method="POST" id="addProductForm" enctype="multipart/form-data">
                <div id="general-error" class="general-error"></div>
                <!-- Product details fields remain the same -->
                <div class="form-group">
                    <label for="productName">Name <span class="required">*</span></label>
                    <input type="text" id="productName" name="productName" class="productName" placeholder="Product name">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-group">
                    <label for="productDescription">Description <span class="required">*</span></label>
                    <textarea id="productDescription" name="description" class="description" placeholder="Product description"></textarea>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="productCategory">Category <span class="required">*</span></label>
                        <select name="category" id="productCategory" class="category">
                            <option disabled selected>Select Category</option>
                            <% for(let i = 0; i < category.length; i++) { %>
                                <option value="<%= category[i]._id %>"><%= category[i].name %></option>
                            <% } %>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="productBrand">Brand <span class="required">*</span></label>
                        <select name="brand" id="productBrand" class="brand">
                            <option disabled selected>Select Product Brand</option>
                            <% for(let i = 0; i < brands.length; i++) { %>
                                <option value="<%= brands[i]._id %>"><%= brands[i].brandName %></option>
                            <% } %>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="regularPrice">Regular Price <span class="required">*</span></label>
                        <input type="number" id="regularPrice" name="regularPrice" class="regularPrice" step="0.01" placeholder="Regular Price">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="salePrice">Sale Price <span class="required">*</span></label>
                        <input type="number" id="salePrice" name="salePrice" class="salePrice" step="0.01" placeholder="Sale Price">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="productStock">Stock <span class="required">*</span></label>
                        <input type="number" id="productStock" name="stock" class="stock" placeholder="Stock">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="productOffer">Product Offer (%)</label>
                        <input type="number" id="productOffer" name="productOffer" class="productOffer" placeholder="Product Offer">
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <!-- Modified Image Upload Section -->
                    <div class="form-group image-group" style="grid-column: span 2;">
                        <label for="productImages">Product Images <span class="required">*</span> (Up to 4 images)</label>
                        <input type="file" id="productImages" name="productImage" accept="image/*" class="productImage" hidden multiple>
                        <div class="invalid-feedback"></div>
                        
                        <div class="image-preview-container" id="imagePreviewContainer">
                            <div class="image-preview-box" data-index="0" onclick="triggerFileInput()"></div>
                            <div class="image-preview-box" data-index="1" onclick="triggerFileInput()"></div>
                            <div class="image-preview-box" data-index="2" onclick="triggerFileInput()"></div>
                            <div class="image-preview-box" data-index="3" onclick="triggerFileInput()"></div>
                        </div>
                    </div>
                    
                    <div class="image-cropper-container" id="cropperContainer" style="display: none;">
                        <img id="cropperImage" src="" alt="Image to Crop">
                        <div class="cropper-controls">
                            <div class="cropper-size-controls">
                                <label for="cropperAspectRatio">Aspect Ratio:</label>
                                <select id="cropperAspectRatio">
                                    <option value="1">1:1 (Square)</option>
                                    <option value="1.33">4:3</option>
                                    <option value="0.75">3:4</option>
                                    <option value="1.78">16:9</option>
                                    <option value="0.56">9:16</option>
                                    <option value="1.25">5:4</option>
                                    <option value="0.8">4:5</option>
                                    <option value="2.35">21:9 (Cinematic)</option>
                                    <option value="3">3:1 (Panorama)</option>
                                    <option value="0">Free (No Constraint)</option>
                                </select>
                            </div>
                            <div class="cropper-buttons">
                                <button type="button" id="cropSaveButton" class="btn-sm btn-primary">Crop & Save</button>
                                <button type="button" id="cropCancelButton" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn save-btn">Add Product</button>
                    <div class="checkbox-group">
                        <label>Block Product: 
                            <input type="checkbox" id="blockProduct" name="isBlocked">
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <!-- Edit Product Modal -->
    <div class="modal product-modal" id="editProductModal">
        <div class="modal-content">
            <button type="button" class="close-btn" id="cancelEditProductButton">×</button>
            <div class="modal-header">
                <h2>Edit Product</h2>
            </div>
            <form action="/admin/editProduct" method="POST" id="editProductForm" enctype="multipart/form-data">
                <div id="general-error" class="general-error"></div>
                <input type="hidden" id="productId" name="id">
                <input type="hidden" id="page" name="currentPages">
                <!-- Product details fields remain the same -->
                <div class="form-group">
                    <label for="editProductName">Name <span class="required">*</span></label>
                    <input type="text" id="editProductName" name="productName" class="productName" placeholder="Product name">
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-group">
                    <label for="editProductDescription">Description <span class="required">*</span></label>
                    <textarea id="editProductDescription" name="description" class="description" placeholder="Product description"></textarea>
                    <div class="invalid-feedback"></div>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="editProductCategory">Category <span class="required">*</span></label>
                        <select name="category" id="editProductCategory" class="category">
                            <option disabled selected>Select Category</option>
                            <% for(let i = 0; i < category.length; i++) { %>
                                <option value="<%= category[i]._id %>"><%= category[i].name %></option>
                            <% } %>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="editProductBrand">Brand <span class="required">*</span></label>
                        <select name="brand" id="editProductBrand" class="brand">
                            <option disabled selected>Select Product Brand</option>
                            <% for(let i = 0; i < brands.length; i++) { %>
                                <option value="<%= brands[i]._id %>"><%= brands[i].brandName %></option>
                            <% } %>
                        </select>
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="editRegularPrice">Regular Price <span class="required">*</span></label>
                        <input type="number" id="editRegularPrice" name="regularPrice" class="regularPrice" step="0.01" placeholder="Regular Price">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="editSalePrice">Sale Price <span class="required">*</span></label>
                        <input type="number" id="editSalePrice" name="salePrice" class="salePrice" step="0.01" placeholder="Sale Price">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="editProductStock">Stock <span class="required">*</span></label>
                        <input type="number" id="editProductStock" name="stock" class="stock" placeholder="Stock">
                        <div class="invalid-feedback"></div>
                    </div>
                    <div class="form-group">
                        <label for="editProductOffer">Product Offer (%)</label>
                        <input type="number" id="editProductOffer" name="productOffer" class="productOffer" placeholder="Product Offer">
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <!-- Modified Image Upload Section for Edit -->
                    <div class="form-group image-group" style="grid-column: span 2;">
                        <label for="editProductImages">Product Images (Up to 4 images)</label>
                        <input type="file" id="editProductImages" accept="image/*" class="productImage" hidden multiple>
                        <div class="invalid-feedback"></div>
                        
                        <div class="image-preview-container" id="editImagePreviewContainer">
                            <div class="image-preview-box" data-index="0" onclick="triggerEditFileInput()"></div>
                            <div class="image-preview-box" data-index="1" onclick="triggerEditFileInput()"></div>
                            <div class="image-preview-box" data-index="2" onclick="triggerEditFileInput()"></div>
                            <div class="image-preview-box" data-index="3" onclick="triggerEditFileInput()"></div>
                        </div>
                    </div>
                    
                    <div class="image-cropper-container" id="editCropperContainer" style="display: none;">
                        <img id="editCropperImage" src="" alt="Image to Crop">
                        <div class="cropper-controls">
                            <div class="cropper-size-controls">
                                <label for="editCropperAspectRatio">Aspect Ratio:</label>
                                <select id="editCropperAspectRatio">
                                    <option value="1">1:1 (Square)</option>
                                    <option value="1.33">4:3</option>
                                    <option value="0.75">3:4</option>
                                    <option value="1.78">16:9</option>
                                    <option value="0.56">9:16</option>
                                    <option value="1.25">5:4</option>
                                    <option value="0.8">4:5</option>
                                    <option value="2.35">21:9 (Cinematic)</option>
                                    <option value="3">3:1 (Panorama)</option>
                                    <option value="0">Free (No Constraint)</option>
                                </select>
                            </div>
                            <div class="cropper-buttons">
                                <button type="button" id="editCropSaveButton" class="btn-sm btn-primary">Crop & Save</button>
                                <button type="button" id="editCropCancelButton" class="btn btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn save-btn">Save Changes</button>
                    <div class="checkbox-group">
                        <label>Block Product: 
                            <input type="checkbox" id="editBlockProduct" name="isBlocked">
                        </label>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Product Modal -->
    <div class="modal product-modal" id="deleteProductModal">
        <div class="modal-content">
            <h2>Confirm Delete</h2>
            <p id="deleteProductMessage"></p>
            <div class="form-actions">
                <button type="button" class="btn delete-btn" id="confirmDeleteButton">Delete</button>
                <button type="button" class="btn cancel-btn" id="cancelDeleteButton">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <script src="/javascript/admins/product.js"></script>
    
</body>
</html>