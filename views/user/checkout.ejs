<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Page | CAMZONE</title>
    <link rel="stylesheet" href="/stylesheet/user/checkout.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header -->
    <%- include('../partials/users/header', { search, cart }) %>

    <!-- Breadcrumb Navigation -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
            <li class="breadcrumb-item active" aria-current="page">Checkout</li>
        </ol>
    </nav>

    <!-- Main Checkout Section -->
    <main class="checkout-container">
        <!-- Billing Details Section -->
        <section class="billing-details" aria-labelledby="billing-details-heading">
            <h2 id="billing-details-heading">Billing Details</h2>
            
            <!-- Delivery Address Selection -->
            <div class="address-selection">
                <h3>Delivery Address</h3>
                <div class="address-list">
                    <% address.forEach(addr => { %>
                        <div class="address-item">
                            <label class="address-option">
                                <input type="radio" name="address" class="address-radio" value="<%= addr._id %>" aria-label="Select delivery address for <%= addr.name %> at <%= addr.streetAddress %>, <%= addr.city %>">
                                <span class="address-details">
                                    <%= addr.name %>, <%= addr.streetAddress %>, <%= addr.city %>, <%= addr.state %>, <%=addr.district %> <%= addr.country %>, <%= addr.pincode %> (<%= addr.phone %>)
                                </span>
                            </label>
                            <button type="button" class="edit-address-btn" data-address='<%= JSON.stringify(addr) %>'>Edit</button>
                        </div>
                    <% }) %>
                    <label class="address-option">
                        <input type="radio" name="address" id="newAddressRadio" class="address-radio" aria-label="Add a new address">
                        <span class="address-details">Add a New Address</span>
                    </label>
                </div>
            </div>
        </section>

        <!-- Add Address Modal -->
        <div class="modal" id="addAddressModal" role="dialog" aria-labelledby="addAddressModalTitle" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="addAddressModalTitle">Add New Address</h3>
                    <button type="button" class="modal-close-btn" id="closeAddModalBtn" aria-label="Close modal">×</button>
                </div>
                <div class="modal-body">
                    <form id="addressForm" novalidate>
                        <input type="hidden" id="addressId" name="addressId">
                        <input type="hidden" id="formMode" name="formMode" value="add">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="name">Name <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="name" name="name" placeholder="Name" required aria-required="true" aria-describedby="name-error">
                                <div class="invalid-feedback" id="name-error" role="alert"></div>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone <span class="required" aria-hidden="true">*</span></label>
                                <div class="phone-input-wrapper">
                                    <span class="country-code" id="countryCode1">+91</span>
                                    <input type="tel" id="phone" name="phone" placeholder="Phone Number" required aria-required="true" aria-describedby="phone-error">
                                    <div class="invalid-feedback" id="phone-error" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="country">Country/Region <span class="required" aria-hidden="true">*</span></label>
                                <div class="select-wrapper">
                                    <select id="country" name="country" required aria-required="true" aria-describedby="country-error">
                                        <option value="">Select your Country/Region</option>
                                        <option value="India">India</option>
                                        <option value="USA">United States</option>
                                        <option value="UK">United Kingdom</option>
                                    </select>
                                    <div class="invalid-feedback" id="country-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="city">Town/City <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="city" name="city" placeholder="Town/City" required aria-required="true" aria-describedby="city-error">
                                <div class="invalid-feedback" id="city-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="streetAddress">Street Address <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="streetAddress" name="streetAddress" placeholder="House No. and Street Name" required aria-required="true" aria-describedby="streetAddress-error">
                                <div class="invalid-feedback" id="streetAddress-error" role="alert"></div>
                            </div>
                            <div class="form-group">
                                <label for="landMark">Apartment/Landmark</label>
                                <input type="text" id="landMark" name="landMark" placeholder="Apartment or Landmark" aria-describedby="landMark-error">
                                <div class="invalid-feedback" id="landMark-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="state">State <span class="required" aria-hidden="true">*</span></label>
                                <div class="select-wrapper">
                                    <select id="state" name="state" required aria-required="true" aria-describedby="state-error">
                                        <option value="">Select your State</option>
                                        <option value="Kerala">Kerala</option>
                                        <option value="Karnataka">Karnataka</option>
                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                    </select>
                                    <div class="invalid-feedback" id="state-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="district">District <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="district" name="district" placeholder="District" required aria-required="true" aria-describedby="district-error">
                                <div class="invalid-feedback" id="district-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="altPhone">Alternate Phone</label>
                                <div class="phone-input-wrapper">
                                    <span class="country-code" id="countryCode2">+91</span>
                                    <input type="tel" id="altPhone" name="altPhone" placeholder="Alternate Phone Number" aria-describedby="altPhone-error">
                                    <div class="invalid-feedback" id="altPhone-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="pincode">Pin Code <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="pincode" name="pincode" placeholder="Pin Code" required aria-required="true" aria-describedby="pincode-error">
                                <div class="invalid-feedback" id="pincode-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="addressType">Address Type</label>
                                <div class="address-type-options">
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="home" checked aria-label="Home address">
                                        <span>Home</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="work" aria-label="Work address">
                                        <span>Work</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="other" aria-label="Other address">
                                        <span>Other</span>
                                    </label>
                                </div>
                                <div class="invalid-feedback" id="addressType-error" role="alert"></div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="modal-cancel-btn" id="cancelAddModalBtn">Cancel</button>
                            <button type="button" class="add-address-btn" id="addAddressBtn">Add Address</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Edit Address Modal -->
        <div class="modal" id="editAddressModal" role="dialog" aria-labelledby="editAddressModalTitle" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="editAddressModalTitle">Edit Address</h3>
                    <button type="button" class="modal-close-btn" id="closeEditModalBtn" aria-label="Close modal">×</button>
                </div>
                <div class="modal-body">
                    <form id="editAddressForm" novalidate>
                        <input type="hidden" id="editAddressId" name="addressId">
                        <input type="hidden" id="editFormMode" name="formMode" value="edit">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editName">Name <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="editName" name="name" placeholder="Name" required aria-required="true" aria-describedby="editName-error">
                                <div class="invalid-feedback" id="editName-error" role="alert"></div>
                            </div>
                            <div class="form-group">
                                <label for="editPhone">Phone <span class="required" aria-hidden="true">*</span></label>
                                <div class="phone-input-wrapper">
                                    <span class="country-code" id="editCountryCode1">+91</span>
                                    <input type="tel" id="editPhone" name="phone" placeholder="Phone Number" required aria-required="true" aria-describedby="editPhone-error">
                                    <div class="invalid-feedback" id="editPhone-error" role="alert"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editCountry">Country/Region <span class="required" aria-hidden="true">*</span></label>
                                <div class="select-wrapper">
                                    <select id="editCountry" name="country" required aria-required="true" aria-describedby="editCountry-error">
                                        <option value="">Select your Country/Region</option>
                                        <option value="India">India</option>
                                        <option value="USA">United States</option>
                                        <option value="UK">United Kingdom</option>
                                    </select>
                                    <div class="invalid-feedback" id="editCountry-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editCity">Town/City <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="editCity" name="city" placeholder="Town/City" required aria-required="true" aria-describedby="editCity-error">
                                <div class="invalid-feedback" id="editCity-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editStreetAddress">Street Address <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="editStreetAddress" name="streetAddress" placeholder="House No. and Street Name" required aria-required="true" aria-describedby="editStreetAddress-error">
                                <div class="invalid-feedback" id="editStreetAddress-error" role="alert"></div>
                            </div>
                            <div class="form-group">
                                <label for="editLandMark">Apartment/Landmark</label>
                                <input type="text" id="editLandMark" name="landMark" placeholder="Apartment or LandMark" aria-describedby="editLandMark-error">
                                <div class="invalid-feedback" id="editLandMark-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editState">State <span class="required" aria-hidden="true">*</span></label>
                                <div class="select-wrapper">
                                    <select id="editState" name="state" required aria-required="true" aria-describedby="editState-error">
                                        <option value="">Select your State</option>
                                        <option value="Kerala">Kerala</option>
                                        <option value="Karnataka">Karnataka</option>
                                        <option value="Tamil Nadu">Tamil Nadu</option>
                                    </select>
                                    <div class="invalid-feedback" id="editState-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editDistrict">District <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="editDistrict" name="district" placeholder="District" required aria-required="true" aria-describedby="editDistrict-error">
                                <div class="invalid-feedback" id="editDistrict-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAltPhone">Alternate Phone</label>
                                <div class="phone-input-wrapper">
                                    <span class="country-code" id="editCountryCode2">+91</span>
                                    <input type="tel" id="editAltPhone" name="altPhone" placeholder="Alternate Phone Number" aria-describedby="editAltPhone-error">
                                    <div class="invalid-feedback" id="editAltPhone-error" role="alert"></div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="editPincode">Pin Code <span class="required" aria-hidden="true">*</span></label>
                                <input type="text" id="editPincode" name="pincode" placeholder="Pin Code" required aria-required="true" aria-describedby="editPincode-error">
                                <div class="invalid-feedback" id="editPincode-error" role="alert"></div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editAddressType">Address Type</label>
                                <div class="address-type-options">
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="home" checked aria-label="Home address">
                                        <span>Home</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="work" aria-label="Work address">
                                        <span>Work</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="addressType" value="other" aria-label="Other address">
                                        <span>Other</span>
                                    </label>
                                </div>
                                <div class="invalid-feedback" id="editAddressType-error" role="alert"></div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="modal-cancel-btn" id="cancelEditModalBtn">Cancel</button>
                            <button type="button" class="add-address-btn" id="updateAddressBtn">Update Address</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Order Summary Section -->
        <section class="order-summary" aria-labelledby="order-summary-heading">
            <h3 id="order-summary-heading">Order Summary</h3>
            <div class="summary-details"> 
                <p>Subtotal: <span>₹<%= cart.totalAmount.toLocaleString('en-IN') %></span></p> 
                <p>Shipping: <span>₹<%= (cart.shippingCost || 0).toLocaleString('en-IN') %></span></p>
                <p>Saved: <span>-₹<%= totalOfferedPrice.toLocaleString('en-IN') %></span></p>
                
                <!-- Enhanced Coupon Section -->
                <div class="coupon-section">
                    <div class="coupon-header">
                        <h4 class="coupon-title">Have a Coupon?</h4>
                        <a href="/coupon" class="browse-coupons-link">
                            Coupons <i class="fas fa-chevron-right"></i>
                        </a>
                    </div>
                    
                    <div class="coupon-input-container">
                        <input type="password" id="couponCode" placeholder="Enter coupon code" class="coupon-input" aria-label="Enter coupon code">
                        <button id="applyCoupon" class="apply-coupon-btn">Apply</button>
                    </div>
                    
                    <div id="couponMessage" class="coupon-message" style="display: none;"></div>
                    
                    <% if (locals.appliedCoupon) { %>
                    <div class="applied-coupon">
                        <div class="coupon-info">
                            <span class="coupon-code"><%= appliedCoupon.code %></span>
                            <span class="coupon-discount">-₹<%= appliedCoupon.discount.toLocaleString('en-IN') %></span>
                        </div>
                        <button id="removeCoupon" class="remove-coupon-btn" aria-label="Remove coupon">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <% } %>
                </div>
                
                <p>Coupon Discount: <span id="couponDiscount">-₹ <%= (cart.couponDiscount || 0).toLocaleString('en-IN') %></span></p>
                <p>GST (18%): <span id="gst">₹ <%= Number(Math.floor(cart.GST.toFixed(2))).toLocaleString('en-IN') %></span></p>
                <h4>Total: <span id="totalAmount">₹ <%= Math.floor(cart.totalAmount).toLocaleString('en-IN') %></span></h4>
            </div>

            <!-- Divider -->
            <hr class="section-divider">

            <!-- Payment Methods -->
            <div class="payment-methods">
                <h4>Payment Method</h4>
                <label class="payment-option">
                    <input type="radio" name="payment" value="Razorpay" checked aria-label="Pay with RazorPay">
                    RazorPay
                </label>
                <!-- <label class="payment-option">
                    <input type="radio" name="payment" value="Wallet" aria-label="Pay with Wallet">
                    Pay With Wallet
                </label> -->
                <label class="payment-option">
                    <input type="radio" name="payment" value="Cash On Delivery" aria-label="Cash on Delivery">
                    Cash on Delivery
                </label>
            </div>

            <!-- Place Order Button -->
            <button type="button" class="place-order" id="placeOrderBtn">Place Order</button>
        </section>
    </main>

    <!-- Footer -->
    <%- include('../partials/users/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/javascript/users/checkout.js"></script>

</body>
</html>