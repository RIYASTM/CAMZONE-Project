<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAMZONE-SHOP</title>
    <link rel="stylesheet" href="/stylesheet/user/shop.css">
</head>
<body>
    <header>
        <%- include('../partials/users/header', {search, cart}) %>
    </header>
    <nav>
        <a href="/">Home</a> > <a href="/shop">All Products</a>
    </nav>
    <div class="container">
        <aside class="sidebar">
            <p><button id="clear-all">Clear All Filters</button></p>
            <h2>Filter</h2>
            <p>0 Selected <span><a href="#" id="reset-filter">Reset</a></span></p>
            <label><input type="radio" name="name" class="sortName" value="A-Z"> A - Z </label><br>
            <label><input type="radio" name="name" class="sortName" value="Z-A"> Z - A </label><br>
            
            <!-- Price Filter -->
            <h2>Price</h2>
            <p>0 Selected <span><a href="#" id="reset-price">Reset</a></span></p>
            <label><input type="radio" name="price" class="filterPrice" value="LOW-HIGH"> LOW - HIGH</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="HIGH-LOW"> HIGH - LOW</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="below-10000"> BELOW - 10000</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="10000-50000"> 10000 - 50000</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="50000-100000"> 50000 - 100000</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="100000-500000"> 100000 - 500000</label><br>
            <label><input type="radio" name="price" class="filterPrice" value="above-500000"> ABOVE 500000</label><br>
            
            <!-- Categories Filter -->
            <h2>Categories</h2>
            <p>0 Selected <span><a href="#" id="reset-category">Reset</a></span></p>
            <% if (category && category.length > 0) { %>
                <% category.forEach(cat => { %>
                    <% if (cat.isListed) { %>
                        <label><input type="checkbox" name="category" class="category" value="<%= cat._id %>"> <%= cat.name %></label><br>
                    <% } %>
                <% }) %>
            <% } else { %>
                <p>No categories available.</p>
            <% } %>
            
            <!-- Brand Filter -->
            <h2>Brand</h2>
            <p>0 Selected <span><a href="#" id="reset-brand">Reset</a></span></p>
            <% if (brands && brands.length > 0) { %>
                <% brands.forEach(brand => { %>
                    <% if (!brand.isBlocked) { %>
                        <label><input type="checkbox" name="brand" class="brand" value="<%= brand._id %>"> <%= brand.brandName %></label><br>
                    <% } %>
                <% }) %>
            <% } else { %>
                <p>No brands available.</p>
            <% } %>
        </aside>

        <main class="product-grid">
            <!-- Dynamic Product Listing -->
            <% if (products && products.length > 0) { %>
                <% products.forEach(product => { %>
                    <div class="product-card <%= ['out of stock', 'discontinued'].includes(product.status.toLowerCase()) ? 'dimmed' : '' %>" data-id="<%= product._id %>">
                        <% if(['out of stock', 'discontinued'].includes(product.status.toLowerCase())) {%>
                            <div class="stock-message">
                                <%=product.status.toLowerCase() === 'out of stock' ? 'This item is out of stock' : 'This item is discontinued'%>
                            </div>
                            <%}%>
                        <div class="wishlist-btn <%= wishlistItems.includes(product._id.toString()) ? 'active' : '' %>" data-id="<%= product._id %>">
                            <i class="fa fa-heart"></i>
                        </div>
                        <a href="/product?id=<%= product._id %>">
                            <% if (product.productImage && (Array.isArray(product.productImage) ? product.productImage.length > 0 : product.productImage)) { %>
                                <img src="<%= Array.isArray(product.productImage) ? product.productImage[0] : product.productImage %>" alt="<%= product.productName %>">
                            <% } else { %>
                                <span>No Image</span>
                            <% } %>
                            <h3><%= product.productName.slice(0, 23) %></h3>
                            <p>₹<%= product.salePrice %> <span class="old-price">₹<%= product.regularPrice %></span></p>
                            <div class="bottom-msg">
                                <div class="rating">
                                    <%= '★'.repeat(Math.round(product.rating) || 1) %>
                                    <% if (product.reviews) { %>
                                        (<%= product.reviews %>)
                                    <% } %>
                                </div>
                                <div class="stock-msg">
                                    <%=product.quantity <= 5 && product.quantity !== 0 ? 'Only ' + product.quantity + ' items left' : '' %>
                                </div>
                            </div>
                        </a>
                    </div>
                <% }) %>
            <% } else { %>
                <p>No products available.</p>
            <% } %>
        </main>
    </div>

    <!--Pagination -->
    <div class="pagination" data-total-pages="<%= totalPages %>">
        <span><%= currentPages %> of <%= totalPages %></span>
        <div class="pagination-controls">
            <button <%= currentPages === 1 ? 'disabled' : '' %> 
                    onclick="window.location.href='?page=1<%= finalQuery ? `&${finalQuery}` : '' %>'" 
                    title="Go to first page"><i class="fas fa-angle-double-left"></i></button>
            
            <button <%= currentPages === 1 ? 'disabled' : '' %> 
                    onclick="window.location.href='?page=<%= currentPages - 1 %><%= finalQuery ? `&${finalQuery}` : '' %>'" 
                    title="Previous page"><i class="fas fa-angle-left"></i></button>
            
            <span> - </span>
            
            <button <%= currentPages === totalPages ? 'disabled' : '' %> 
                    onclick="window.location.href='?page=<%= parseInt(currentPages) + 1 %><%= finalQuery ? `&${finalQuery}` : '' %>'" 
                    title="Next page"><i class="fas fa-angle-right"></i></button>
            
            <button <%= currentPages === totalPages ? 'disabled' : '' %> 
                    onclick="window.location.href='?page=<%= totalPages %><%= finalQuery ? `&${finalQuery}` : '' %>'" 
                    title="Go to last page"><i class="fas fa-angle-double-right"></i></button>
        </div>
    </div>

    <div class="banner-image"></div>

    <footer>
        <%- include('../partials/users/footer') %>
    </footer>

    <script src="/javascript/users/shop.js"></script>
</body>
</html>